/**
 * User: Soezen
 * Date: 31/10/13
 * Time: 21:18
 */

var logger = require('./logger');
var loader = require('./resource-loader');
var formidable = require('formidable');
var fs = require('fs');
var mundi = require('sur-snapps-mundi');

function dashboard(request, response) {
    var locals = {
        menu: {
            items: [
                {key: 'dashboard', label: 'Home'},
                {key: 'games', label: 'Games'}
            ]
        }
    };
    loader.loadJade(response, 'dashboard.jade', locals);
}

function games(request, response) {
    var locals = {
        players: mundi.players()
    };
    loader.loadJade(response, 'games.jade', locals);
}

function waitForGame(request, response) {
    var form = new formidable.IncomingForm();
    form.parse(request, function(error, fields, files) {
        mundi.registerWaitingUser(fields.username);
        games(request, response);
    });

}

function stopWaitForGame(request, response) {
    var form = new formidable.IncomingForm();
    form.parse(request, function(error, fields, files) {
        mundi.unregisterWaitingUser(fields.username);
        games(request, response);
    });
}

function start(request, response) {
    logger.log('start');
    response.writeHead(200, {
        "Content-Type": "text/html"
    });
    response.write("<html>");
    response.write("<head>");
    response.write("<meta http-equiv=\"Content-Type\" content='text/html; charset=UTF-8' />");
    response.write("</head>")
    response.write("<body>");
    response.write("<h1>Hello world!</h1>");
    response.write("<p>");
    response.write("<form action='/upload' method='post' enctype='multipart/form-data'>");
    response.write("<input type='file' name='upload' multiple='multiple' />");
    response.write("<input type='submit' value='Submit' />");
    response.write("</form>");
    response.write("</p>");
    response.write("</body>");
    response.write("</html>");
    response.end();
}

function upload(request, response) {
    var form = new formidable.IncomingForm();
    form.parse(request, function(error, fields, files) {
        fs.rename(files.upload.path, "/tmp/test.jpg", function(error) {
            if (error) {
                fs.unlink("/tmp/test.jpg");
                fs.rename(files.upload.path, "/tmp/test.jpg");
            }
        });

        response.writeHead(200, {"Content-Type": "text/html"});
        response.write("<html>");
        response.write("<h1>Received file</h1>");
        response.write("<img src='/show' />");
        response.write("</html>");
        response.end();
    });
}

function show(request, response) {
    loader.load(response, '/tmp', 'test.jpg', 'jpg');
}

function writeHeader(response, code) {
    response.writeHeader(code, {"Content-Type": "text/html"});
}

exports.handle = {
    "/": start,
    "/start": start,
    "/upload": upload,
    "/show": show,
    "/waitForGame": waitForGame,
    "/stopWaitForGame": stopWaitForGame,
    "/games": games,
    "/index": dashboard
};