/**
 * User: Soezen
 * Date: 31/10/13
 * Time: 21:18
 */

var logger = require('./logger');
var sys = require('sys');
var formidable = require('formidable');
var fs = require('fs');

function start(request, response) {
    logger.log('start');
    response.writeHead(200, {
        "Content-Type": "text/html"
    });
    response.write("<html>");
    response.write("<head>");
    response.write("<meta http-equiv=\"Content-Type\" content='text/html; charset=UTF-8' />");
    response.write("</head>")
    response.write("<body>");
    response.write("<h1>Hello world!</h1>");
    response.write("<p>");
    response.write("<form action='/upload' method='post' enctype='multipart/form-data'>");
    response.write("<input type='file' name='upload' multiple='multiple' />");
    response.write("<input type='submit' value='Submit' />");
    response.write("</form>");
    response.write("</p>");
    response.write("</body>");
    response.write("</html>");
    response.end();
}

function upload(request, response) {
    var form = new formidable.IncomingForm();
    form.parse(request, function(error, fields, files) {
        fs.rename(files.upload.path, "/tmp/test.jpg", function(error) {
            if (error) {
                fs.unlink("/tmp/test.jpg");
                fs.rename(files.upload.path, "/tmp/test.jpg");
            }
        });

        response.writeHead(200, {"Content-Type": "text/html"});
        response.write("<html>");
        response.write("<h1>Received file</h1>");
        response.write("<img src='/show' />");
        response.write("</html>");
        response.end();
    });
}

function show(request, response) {
    fs.readFile("/tmp/test.jpg", "binary", function(error, file) {
        if (error) {
            response.writeHead(500, {"Content-Type": "text/plain"});
            response.write("error: " + error);
            response.end();
        } else {
            response.writeHead(200, {"Content-Type": "image/jpg"});
            response.write(file, "binary");
            response.end();
        }
    });
}

function writeHeader(response, code) {
    response.writeHeader(code, {"Content-Type": "text/html"});
}

exports.handle = {
    "/": start,
    "/start": start,
    "/upload": upload,
    "/show": show
};