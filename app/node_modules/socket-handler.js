/**
 * User: Soezen
 * Date: 8/12/13
 * Time: 19:28
 */

var mundi = require('./sur-snapps-mundi');
var io;

function handle(socket) {
    socket.on('login', function(data) {
        socket.set('username', data.username);
        var user = mundi.login(data.username);
        socket.broadcast.emit('player-list-add', user);
    });
    socket.on('disconnect', function() {
        socket.get('username', function(error, username) {
            if (!error) {
                var user = mundi.logout(username);
                if (user != null) {
                    socket.broadcast.emit('player-list-delete', user);
                }
            }
        });
    });
    socket.on('request-game', function(data) {
        data.requester = mundi.findPlayer(data.requester);
        socket.broadcast.emit('game-request-' + data.opponent, data);
    });
    socket.on('revoke-request', function(data) {
        socket.broadcast.emit('request-revoked-' + data.opponent, data);
    });
    socket.on('accept-request', function(data) {
        var game = io.of(data.gameName).on('connection', function(gameSocket) {
            handleGame(gameSocket, game);
        });
        game.game = {
            name: data.gameName
        };

        socket.broadcast.emit('request-accepted-' + data.opponent, {
            gameName: data.gameName
        });
    });
}

function handleGame(inSocket, outSocket) {
    inSocket.on('ready', function(data) {
        inSocket.set('username', data.username);

        outSocket.emit('test', data);
    });
    inSocket.on('test', function() {
        console.log('playing in game: ' + outSocket.game.name);
    });
}

function setIo(input) {
    io = input;
}

exports.handle = handle;
exports.setIo = setIo;